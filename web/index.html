<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Studio - Manager Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }

        h1 {
            color: #4a9eff;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            background: #2a2a2a;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 10px;
        }

        .status.online {
            background: #1a4d2e;
            color: #4ade80;
        }

        .status.offline {
            background: #4d1a1a;
            color: #ff6b6b;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .task-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #333;
        }

        .task-card h2 {
            color: #4a9eff;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .task-card p {
            color: #999;
            font-size: 14px;
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 12px;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            resize: vertical;
            min-height: 200px;
            margin-bottom: 15px;
        }

        textarea:focus {
            outline: none;
            border-color: #4a9eff;
        }

        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background: #357abd;
        }

        button:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .result-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #333;
            display: none;
        }

        .result-section.visible {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }

        .result-header h2 {
            color: #4a9eff;
            font-size: 20px;
        }

        .result-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .meta-item {
            color: #999;
        }

        .meta-item span {
            color: #4a9eff;
            font-weight: 600;
        }

        .result-content {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 20px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.8;
            max-height: 600px;
            overflow-y: auto;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading.visible {
            display: block;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #4d1a1a;
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .error.visible {
            display: block;
        }

        .btn-secondary {
            background: #444;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .artifacts-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #333;
            margin-top: 20px;
        }

        .artifacts-section h2 {
            color: #4a9eff;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .artifact-list {
            display: grid;
            gap: 10px;
        }

        .artifact-item {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .artifact-name {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .artifact-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: #888;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #00d9ff;
            border-bottom-color: #00d9ff;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* History Tab */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .history-controls select {
            background: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .history-item:hover {
            border-color: #00d9ff;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-type {
            display: inline-block;
            padding: 4px 12px;
            background: #00d9ff;
            color: #000;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .history-item-time {
            color: #888;
            font-size: 14px;
        }

        .history-item-preview {
            color: #ccc;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-expanded {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
            display: none;
        }

        .history-item.expanded .history-item-expanded {
            display: block;
        }

        .history-item-expanded h4 {
            color: #4a9eff;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .history-item-expanded pre {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        /* Chat UI */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            background: #2a2a2a;
            border-radius: 12px;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #444;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-welcome {
            text-align: center;
            color: #888;
            padding: 40px;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            max-width: 80%;
        }

        .chat-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-message.assistant {
            align-self: flex-start;
        }

        .chat-message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .chat-message.user .chat-message-avatar {
            background: #00d9ff;
            color: #000;
        }

        .chat-message.assistant .chat-message-avatar {
            background: #555;
            color: #fff;
        }

        .chat-message-content {
            background: #333;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
        }

        .chat-message.user .chat-message-content {
            background: #00d9ff;
            color: #000;
        }

        .chat-message-time {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #444;
        }

        .chat-input-container textarea {
            flex: 1;
            background: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            resize: none;
            font-family: inherit;
        }

        .chat-input-container button {
            padding: 12px 24px;
        }

        @keyframes blink {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .typing-indicator {
            display: inline-block;
            animation: blink 1.4s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Studio - Manager Console</h1>
            <div class="status" id="status">
                <span id="statusText">Checking...</span>
            </div>
        </header>

        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('tasks')">Tasks</button>
            <button class="tab-btn" onclick="switchTab('code')">Generate Code</button>
            <button class="tab-btn" onclick="switchTab('chat')">Chat</button>
            <button class="tab-btn" onclick="switchTab('history')">History</button>
        </div>

        <div class="error" id="error"></div>

        <!-- Tasks Tab -->
        <div id="tasks-tab" class="tab-panel active">
        <div class="main-grid">
            <!-- Validate Task -->
            <div class="task-card">
                <h2>Validate Game Idea</h2>
                <p>Get structured feedback on game concepts. Returns strengths, issues, market viability, and next steps.</p>
                <textarea id="validateInput" placeholder="Enter your game idea here...

Example:
A cooperative multiplayer game where players are members of a space station crew dealing with escalating system failures..."></textarea>
                <button onclick="submitTask('validate')" id="validateBtn">Validate Idea</button>
            </div>

            <!-- Review Task -->
            <div class="task-card">
                <h2>Review Architecture</h2>
                <p>Get technical feedback on architecture decisions. Returns risk assessment, recommendations, and verdict.</p>
                <textarea id="reviewInput" placeholder="Enter your architecture document here...

Example:
# Game Architecture - Strategy Game

## Core Systems
- Hex grid pathfinding with A* algorithm
- Component-based unit system
..."></textarea>
                <button onclick="submitTask('review')" id="reviewBtn">Review Architecture</button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Processing... This may take 4-50 seconds depending on model state.</div>
        </div>

        <!-- Results Section -->
        <div class="result-section" id="results">
            <div class="result-header">
                <h2>Results</h2>
                <div>
                    <button onclick="copyResults()" class="btn-secondary btn-small">Copy</button>
                    <button onclick="closeResults()" class="btn-secondary btn-small">Close</button>
                </div>
            </div>
            <div class="result-meta">
                <div class="meta-item">Task: <span id="resultTask"></span></div>
                <div class="meta-item">Model: <span id="resultModel"></span></div>
                <div class="meta-item">Duration: <span id="resultDuration"></span>s</div>
            </div>
            <div class="result-content" id="resultContent"></div>
        </div>

        <!-- Artifacts Section -->
        <div class="artifacts-section">
            <h2>Recent Artifacts</h2>
            <div class="artifact-list" id="artifactList">
                <div style="color: #999; font-size: 14px;">Artifacts saved to: ./artifacts/</div>
                <div style="color: #666; font-size: 13px;">Check the artifacts folder for all saved results.</div>
            </div>
        </div>
        </div>
        <!-- End Tasks Tab -->

        <!-- Code Generation Tab -->
        <div id="code-tab" class="tab-panel">
            <div class="task-card" style="max-width: 900px; margin: 0 auto;">
                <h2>Generate Code</h2>
                <p>AI will analyze your request, choose the optimal tech stack (language/framework), and generate production-quality code.</p>
                <p style="font-size: 14px; color: #888; margin-top: 10px;">
                    <strong>Works for:</strong> Games ‚Ä¢ Mobile Apps ‚Ä¢ Web Apps ‚Ä¢ Backend APIs ‚Ä¢ Desktop Tools
                </p>
                <textarea id="codeInput" placeholder="Describe what you want to build...

Examples:
‚Ä¢ A roguelike game where you play as a virus infecting a human body
‚Ä¢ Mobile app to track daily habits with charts and reminders
‚Ä¢ REST API for user authentication with JWT tokens
‚Ä¢ Desktop tool to batch resize and convert images
‚Ä¢ 2D platformer with wall-jumping mechanics

The AI will choose the best language and framework for your specific needs." rows="8"></textarea>
                <button onclick="submitTask('code')" id="codeBtn">Generate Code</button>
                <div style="margin-top: 15px; padding: 12px; background: #2a2a2a; border-radius: 4px; font-size: 13px;">
                    <strong>üí° Tip:</strong> After generation, use the "Review Architecture" task to evaluate the tech stack choices and code quality.
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="codeLoading" style="display: none;">
                <div class="spinner"></div>
                <div>Generating code... This may take 10-60 seconds for complex projects.</div>
            </div>

            <!-- Code Results Section -->
            <div class="result-section" id="codeResults" style="display: none;">
                <div class="result-header">
                    <h2>Generated Code</h2>
                    <div>
                        <button onclick="copyCodeResults()" class="btn-secondary btn-small">Copy All</button>
                        <button onclick="closeCodeResults()" class="btn-secondary btn-small">Close</button>
                    </div>
                </div>
                <div class="result-meta">
                    <div class="meta-item">Model: <span id="codeResultModel"></span></div>
                    <div class="meta-item">Duration: <span id="codeResultDuration"></span>s</div>
                </div>
                <div class="result-content" id="codeResultContent"></div>
            </div>
        </div>
        <!-- End Code Generation Tab -->

        <!-- Chat Tab -->
        <div id="chat-tab" class="tab-panel">
            <div class="chat-container">
                <div class="chat-header">
                    <h2>Brainstorm with AI</h2>
                    <button onclick="newConversation()" class="btn-secondary">New Conversation</button>
                </div>
                <div id="chat-messages" class="chat-messages">
                    <div class="chat-welcome">
                        <p>Start brainstorming your game ideas!</p>
                        <p>The AI will remember context throughout the conversation.</p>
                    </div>
                </div>
                <div class="chat-input-container">
                    <textarea id="chatInput" placeholder="Type your message... (Shift+Enter for new line)" rows="3"></textarea>
                    <button onclick="sendChatMessage()" id="chatSendBtn">Send</button>
                </div>
            </div>
        </div>
        <!-- End Chat Tab -->

        <!-- History Tab -->
        <div id="history-tab" class="tab-panel">
            <div class="history-header">
                <h2>Task History</h2>
                <div class="history-controls">
                    <select id="historyFilter" onchange="filterHistory()">
                        <option value="all">All Tasks</option>
                        <option value="validate">Validate Only</option>
                        <option value="review">Review Only</option>
                        <option value="code">Code Only</option>
                        <option value="chat">Chat Only</option>
                    </select>
                    <button onclick="exportHistory()">Export as Markdown</button>
                </div>
            </div>
            <div id="history-list" class="history-list">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        <!-- End History Tab -->

    </div>

    <script>
        const API_URL = 'http://localhost:8080';

        // Check server health on load
        async function checkHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();

                if (data.status === 'healthy') {
                    document.getElementById('status').className = 'status online';
                    document.getElementById('statusText').textContent = 'Server Online - Ollama Connected';
                } else {
                    throw new Error('Server unhealthy');
                }
            } catch (error) {
                document.getElementById('status').className = 'status offline';
                document.getElementById('statusText').textContent = 'Server Offline';
                showError('Cannot connect to orchestrator. Make sure the server is running:\n./orchestrator -mode=server -port=8080');
            }
        }

        // Submit task
        async function submitTask(taskType) {
            // Map task types to input/button IDs
            const inputId = `${taskType}Input`;
            const btnId = `${taskType}Btn`;
            const loadingId = taskType === 'code' ? 'codeLoading' : 'loading';
            const resultsId = taskType === 'code' ? 'codeResults' : 'results';

            const input = document.getElementById(inputId).value.trim();

            if (!input) {
                showError('Please enter some text before submitting.');
                return;
            }

            // Hide previous results and errors
            hideError();
            if (taskType === 'code') {
                document.getElementById('codeResults').style.display = 'none';
            } else {
                document.getElementById('results').classList.remove('visible');
            }

            // Show loading
            if (taskType === 'code') {
                document.getElementById('codeLoading').style.display = 'flex';
            } else {
                document.getElementById('loading').classList.add('visible');
            }

            // Disable all task buttons
            document.getElementById('validateBtn').disabled = true;
            document.getElementById('reviewBtn').disabled = true;
            document.getElementById('codeBtn').disabled = true;

            try {
                const response = await fetch(`${API_URL}/task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_type: taskType,
                        input: input
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Task execution failed');
                }

                const result = await response.json();

                // Display results based on task type
                if (taskType === 'code') {
                    displayCodeResults(result);
                } else {
                    displayResults(result);
                }

            } catch (error) {
                showError(`Error: ${error.message}`);
            } finally {
                // Hide loading and re-enable buttons
                if (taskType === 'code') {
                    document.getElementById('codeLoading').style.display = 'none';
                } else {
                    document.getElementById('loading').classList.remove('visible');
                }
                document.getElementById('validateBtn').disabled = false;
                document.getElementById('reviewBtn').disabled = false;
                document.getElementById('codeBtn').disabled = false;
            }
        }

        // Display code generation results
        function displayCodeResults(result) {
            document.getElementById('codeResultModel').textContent = result.model;
            document.getElementById('codeResultDuration').textContent = result.duration_seconds.toFixed(2);
            document.getElementById('codeResultContent').textContent = result.output;
            document.getElementById('codeResults').style.display = 'block';

            // Scroll to results
            document.getElementById('codeResults').scrollIntoView({ behavior: 'smooth' });
        }

        // Display results
        function displayResults(result) {
            document.getElementById('resultTask').textContent = result.task_type;
            document.getElementById('resultModel').textContent = result.model;
            document.getElementById('resultDuration').textContent = result.duration_seconds.toFixed(2);
            document.getElementById('resultContent').textContent = result.output;
            document.getElementById('results').classList.add('visible');

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // Copy results to clipboard
        function copyResults() {
            const content = document.getElementById('resultContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('Results copied to clipboard!');
            });
        }

        // Close results
        function closeResults() {
            document.getElementById('results').classList.remove('visible');
        }

        // Show error
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('visible');
        }

        // Hide error
        function hideError() {
            document.getElementById('error').classList.remove('visible');
        }

        // Tab Management
        let historyData = [];

        function switchTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Deactivate all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected panel
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Activate clicked button
            event.target.classList.add('active');

            // Load history if switching to history tab
            if (tabName === 'history') {
                loadHistory();
            }
        }

        // History Management
        async function loadHistory() {
            try {
                const filter = document.getElementById('historyFilter').value;
                const response = await fetch(`${API_URL}/history?task_type=${filter}`);
                historyData = await response.json();
                renderHistory();
            } catch (error) {
                console.error('Failed to load history:', error);
                document.getElementById('history-list').innerHTML =
                    '<p style="color: #ff6b6b; text-align: center; padding: 40px;">Failed to load history. Server may be offline.</p>';
            }
        }

        function renderHistory() {
            const listEl = document.getElementById('history-list');

            if (!historyData || historyData.length === 0) {
                listEl.innerHTML = '<p style="color: #888; text-align: center; padding: 40px;">No tasks in history yet. Run some tasks to see them here!</p>';
                return;
            }

            listEl.innerHTML = historyData.map((task, index) => `
                <div class="history-item" onclick="toggleHistoryItem(${index})">
                    <div class="history-item-header">
                        <span class="history-item-type">${task.task_type}</span>
                        <span class="history-item-time">${formatTimestamp(task.timestamp)} ‚Ä¢ ${task.duration_seconds.toFixed(2)}s</span>
                    </div>
                    <div class="history-item-preview">${escapeHtml(task.input.substring(0, 100))}...</div>
                    <div class="history-item-expanded">
                        <h4>Input:</h4>
                        <pre>${escapeHtml(task.input)}</pre>
                        <h4>Output:</h4>
                        <pre>${escapeHtml(task.output)}</pre>
                        <button onclick="rerunTask(${index}, event)" class="btn-secondary">Re-run This Task</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleHistoryItem(index) {
            const items = document.querySelectorAll('.history-item');
            items[index].classList.toggle('expanded');
        }

        function filterHistory() {
            loadHistory();
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function rerunTask(index, event) {
            event.stopPropagation(); // Prevent collapsing

            const task = historyData[index];

            // Switch to tasks tab
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tasks-tab').classList.add('active');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');

            // Fill the appropriate textarea
            if (task.task_type === 'validate') {
                document.getElementById('validateInput').value = task.input;
            } else if (task.task_type === 'review') {
                document.getElementById('reviewInput').value = task.input;
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function exportHistory() {
            try {
                const response = await fetch(`${API_URL}/export`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `history_${Date.now()}.md`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export history. Server may be offline.');
            }
        }

        // Chat Management
        let currentConversationId = null;

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Disable input
            input.disabled = true;
            document.getElementById('chatSendBtn').disabled = true;

            // Add user message to UI
            addChatMessage('user', message);

            // Clear input
            input.value = '';

            // Show typing indicator
            const typingId = addTypingIndicator();

            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        message: message
                    })
                });

                const data = await response.json();

                // Update conversation ID
                currentConversationId = data.conversation_id;

                // Remove typing indicator
                removeTypingIndicator(typingId);

                // Add AI response
                addChatMessage('assistant', data.response);

            } catch (error) {
                console.error('Chat error:', error);
                removeTypingIndicator(typingId);
                addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            } finally {
                // Re-enable input
                input.disabled = false;
                document.getElementById('chatSendBtn').disabled = false;
                input.focus();
            }
        }

        function addChatMessage(role, content) {
            const messagesDiv = document.getElementById('chat-messages');

            // Remove welcome message if present
            const welcome = messagesDiv.querySelector('.chat-welcome');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            const avatar = role === 'user' ? 'M' : 'AI';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `
                <div class="chat-message-avatar">${avatar}</div>
                <div>
                    <div class="chat-message-content">${escapeHtml(content)}</div>
                    <div class="chat-message-time">${time}</div>
                </div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addTypingIndicator() {
            const messagesDiv = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            const id = 'typing_' + Date.now();
            typingDiv.id = id;
            typingDiv.className = 'chat-message assistant';
            typingDiv.innerHTML = `
                <div class="chat-message-avatar">AI</div>
                <div class="chat-message-content">
                    <span class="typing-indicator">‚óè‚óè‚óè</span>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return id;
        }

        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function newConversation() {
            if (currentConversationId && !confirm('Start a new conversation? Current context will be lost.')) {
                return;
            }

            currentConversationId = null;
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = `
                <div class="chat-welcome">
                    <p>Start brainstorming your game ideas!</p>
                    <p>The AI will remember context throughout the conversation.</p>
                </div>
            `;
        }

        // Initialize
        checkHealth();
        // Code Generation Functions
        function copyCodeResults() {
            const content = document.getElementById('codeResultContent').innerText;
            navigator.clipboard.writeText(content);
        }

        function closeCodeResults() {
            document.getElementById('codeResults').style.display = 'none';
        }

        setInterval(checkHealth, 30000); // Check every 30 seconds

        // Chat keyboard shortcuts
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });
    </script>
</body>
</html>
